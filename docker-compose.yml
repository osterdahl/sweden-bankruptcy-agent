version: "3.8"

services:
  bankruptcy-agent:
    build: .
    container_name: sweden-bankruptcy-agent
    restart: unless-stopped
    
    # For scheduled runs
    command: python scheduler.py
    
    environment:
      # Scraping settings
      - HEADLESS=true
      - REQUEST_DELAY=1.0
      - MAX_RETRIES=3
      - TIMEOUT=30
      
      # Database
      - DATABASE_PATH=/app/data/bankruptcies.db
      - EXPORT_PATH=/app/data/exports
      
      # Filter criteria (customize these)
      - FILTER_MIN_EMPLOYEES=5
      - FILTER_MIN_REVENUE=1000000
      - FILTER_BUSINESS_TYPES=
      - FILTER_REGIONS=
      - FILTER_EXCLUDE_KEYWORDS=
      - FILTER_INCLUDE_KEYWORDS=
      
      # Email settings (required for notifications)
      - SMTP_SERVER=smtp.gmail.com
      - SMTP_PORT=587
      - SMTP_USE_TLS=true
      - SENDER_EMAIL=${SENDER_EMAIL:-}
      - SENDER_PASSWORD=${SENDER_PASSWORD:-}
      - RECIPIENT_EMAILS=${RECIPIENT_EMAILS:-}
      
      # Schedule
      - SCHEDULE=monthly
      - RUN_DAY_OF_MONTH=1
      
      # Set to 'true' for testing
      - RUN_NOW=false
      - USE_MOCK=false
    
    volumes:
      # Persist database and exports
      - bankruptcy-data:/app/data
      # For development: mount source code
      # - ./src:/app/src:ro
      # - ./config:/app/config:ro
    
    # Limit resources
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 256M

  # Alternative: One-off run (uncomment to use)
  # bankruptcy-agent-oneoff:
  #   build: .
  #   container_name: sweden-bankruptcy-agent-oneoff
  #   command: python main.py --month ${MONTH:-} --year ${YEAR:-}
  #   environment:
  #     - HEADLESS=true
  #     - SENDER_EMAIL=${SENDER_EMAIL:-}
  #     - SENDER_PASSWORD=${SENDER_PASSWORD:-}
  #     - RECIPIENT_EMAILS=${RECIPIENT_EMAILS:-}
  #   volumes:
  #     - bankruptcy-data:/app/data

volumes:
  bankruptcy-data:
    name: sweden-bankruptcy-data
