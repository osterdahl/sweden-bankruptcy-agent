name: Monthly Bankruptcy Report

# Simplified autonomous workflow for single-file bankruptcy monitor
# Runs automatically on the 1st of each month at 6 AM UTC

on:
  schedule:
    - cron: '0 6 1 * *'  # 6 AM UTC on the 1st of every month

  workflow_dispatch:
    inputs:
      year:
        description: 'Year to process (leave blank for auto)'
        required: false
        default: ''
      month:
        description: 'Month to process 1-12 (leave blank for auto)'
        required: false
        default: ''
      enable_ai_scoring:
        description: 'Enable AI scoring (overrides secret setting)'
        required: false
        type: boolean
        default: false
      skip_email:
        description: 'Skip sending email report'
        required: false
        type: boolean
        default: false
      countries:
        description: 'Countries to process (comma-separated: se,no,dk,fi)'
        required: false
        default: 'se'

env:
  PYTHON_VERSION: '3.12'

jobs:
  generate-report:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps

      - name: Determine date parameters
        id: date
        run: |
          if [ -n "${{ github.event.inputs.year }}" ] && [ -n "${{ github.event.inputs.month }}" ]; then
            YEAR="${{ github.event.inputs.year }}"
            MONTH="${{ github.event.inputs.month }}"
            echo "Using manual inputs: $YEAR-$MONTH"
          else
            # Automatic: use previous month if running in first 3 days
            CURRENT_DAY=$(date +%d)
            CURRENT_MONTH=$(date +%m | sed 's/^0//')
            CURRENT_YEAR=$(date +%Y)

            if [ "$CURRENT_DAY" -le 3 ]; then
              echo "Day $CURRENT_DAY - processing PREVIOUS month"
              PREV_DATE=$(date -d "1 month ago" +%Y-%m)
              YEAR=$(echo $PREV_DATE | cut -d'-' -f1)
              MONTH=$(echo $PREV_DATE | cut -d'-' -f2 | sed 's/^0//')
            else
              echo "Day $CURRENT_DAY - processing CURRENT month"
              YEAR=$CURRENT_YEAR
              MONTH=$CURRENT_MONTH
            fi
          fi

          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "month=$MONTH" >> $GITHUB_OUTPUT
          echo "ðŸ“… Processing: $YEAR-$(printf %02d $MONTH)"

      - name: Run bankruptcy monitor
        env:
          # Email configuration (required)
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
          RECIPIENT_EMAILS: ${{ secrets.RECIPIENT_EMAILS }}

          # Date override
          YEAR: ${{ steps.date.outputs.year }}
          MONTH: ${{ steps.date.outputs.month }}

          # Optional filters (defaults: 5 employees, 1M SEK revenue)
          FILTER_REGIONS: ${{ secrets.FILTER_REGIONS }}
          FILTER_INCLUDE_KEYWORDS: ${{ secrets.FILTER_INCLUDE_KEYWORDS }}
          FILTER_MIN_EMPLOYEES: ${{ secrets.FILTER_MIN_EMPLOYEES || '5' }}
          FILTER_MIN_REVENUE: ${{ secrets.FILTER_MIN_REVENUE || '1000000' }}

          # Optional AI scoring (manual override or secret)
          AI_SCORING_ENABLED: ${{ github.event.inputs.enable_ai_scoring == 'true' && 'true' || secrets.AI_SCORING_ENABLED }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

          # Optional: Trustee email lookup via Brave Search API
          LOOKUP_TRUSTEE_EMAIL: ${{ secrets.LOOKUP_TRUSTEE_EMAIL }}
          BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}

          # Skip email if requested
          NO_EMAIL: ${{ github.event.inputs.skip_email }}

          # Multi-country support (comma-separated: se,no,dk,fi)
          COUNTRIES: ${{ github.event.inputs.countries || 'se' }}
        run: |
          python bankruptcy_monitor.py

      - name: Report summary
        if: always()
        run: |
          echo "## ðŸ“Š Bankruptcy Report Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Period:** ${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered:** ${{ github.event_name == 'schedule' && 'ðŸ¤– Automatic' || 'ðŸ”§ Manual' }}" >> $GITHUB_STEP_SUMMARY

  notify-on-failure:
    needs: generate-report
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Send failure notification
        env:
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
          RECIPIENT_EMAILS: ${{ secrets.RECIPIENT_EMAILS }}
        run: |
          python << 'EOF'
          import os
          import smtplib
          from email.mime.text import MIMEText

          sender = os.environ.get('SENDER_EMAIL', '')
          password = os.environ.get('SENDER_PASSWORD', '')
          recipients = os.environ.get('RECIPIENT_EMAILS', '').split(',')

          if not all([sender, password, recipients[0]]):
              print("Email not configured")
              exit(0)

          body = "The monthly bankruptcy monitoring job has failed.\n\n"
          body += "Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n"
          body += "This is an automated notification."

          msg = MIMEText(body)
          msg['From'] = sender
          msg['To'] = ', '.join(recipients)
          msg['Subject'] = 'Bankruptcy Monitor FAILED'

          try:
              server = smtplib.SMTP('smtp.gmail.com', 587, timeout=30)
              server.starttls()
              server.login(sender, password)
              server.send_message(msg)
              server.quit()
              print("Failure notification sent")
          except Exception as e:
              print(f"Failed to send notification: {e}")
          EOF
